<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>views.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>views.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">login_serializer</span>
<span class="kn">from</span> <span class="nn">app.forms</span> <span class="kn">import</span> <span class="n">QuestionForm</span><span class="p">,</span> <span class="n">ReviewQuestionForm</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">,</span> <span class="n">ClassInfo</span><span class="p">,</span> <span class="n">Question</span><span class="p">,</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">flask.ext.principal</span> <span class="kn">import</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">RoleNeed</span><span class="p">,</span> <span class="n">UserNeed</span><span class="p">,</span> <span class="n">identity_loaded</span>
<span class="kn">from</span> <span class="nn">flask.ext.security</span> <span class="kn">import</span> <span class="n">SQLAlchemyUserDatastore</span>
<span class="kn">from</span> <span class="nn">flask.helpers</span> <span class="kn">import</span> <span class="n">get_flashed_messages</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">makeTempFileResp</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>

<span class="n">g_CachedQuestions</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Create a permission with a single Need, in this case a RoleNeed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">user_permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="p">(</span> <span class="n">RoleNeed</span><span class="p">(</span> <span class="s">&#39;user&#39;</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">admin_permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="p">(</span> <span class="n">RoleNeed</span><span class="p">(</span> <span class="s">&#39;admin&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Top level site location. Displays additional buttons for admin: Verify users (if there</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>are any), and provide additional administration. """
pp.logger.debug("user=g.user")
ser = g.user
pp.logger.debug("user.is_verified()")
f user.is_verified():
   try:
       herokuPushVersion = os.environ['rel']
   except KeyError:
       herokuPushVersion = "(rel not set)"
   # imageFileURL = url_for( 'static', filename = 'img/possibly47abc.png' )
   app.logger.debug("render_template")
   return render_template( 'index.html',
       user = user,
       isAdmin = user.is_admin(),
       hasUnverifiedUsers = ( user.is_admin() and User.hasUnverifiedUsers() ),  # redundant on purpose
       help = 'helpMain',
       isDebugging = app.config['DEBUG'],
       version = herokuPushVersion )
lse:
   app.logger.debug("unverifiedUser")
   return redirect( url_for( 'unverifiedUser' ) )</p>
<p>route( '/helpMain' )
n_required
_permission.require()
elpMain():
Help page associated with the main page.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">TODO</span><span class="p">:</span> <span class="n">Make</span> <span class="n">help</span> <span class="n">dynamic</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">__page__Help</span><span class="o">.</span><span class="n">html</span><span class="p">)</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    return render_template( &#39;helpMain.html&#39; )</span>
<span class="s">#DIVIDER</span>

<span class="s">#DIVIDER</span>
<span class="s">@app.route( &#39;/chooseClass&#39; )</span>
<span class="s">@login_required</span>
<span class="s">@user_permission.require()</span>
<span class="s">def chooseClass():</span>
<span class="s">#DIVIDER</span>
<span class="s">    argMode = request.args.get( &#39;mode&#39; )</span>
<span class="s">    if argMode:</span>
<span class="s">        session[&#39;mode&#39;] = argMode</span>
<span class="s">        return render_template( &#39;chooseClass.html&#39;, title = session[&#39;mode&#39;] + &quot;: Choose Class&quot; )</span>
<span class="s">    else:</span>
<span class="s">        flash( &quot;Please choose a task (e.g., &#39;review&#39;) first.&quot; )</span>
<span class="s">        return redirect( url_for( &#39;index&#39; ) )</span>
<span class="s">#DIVIDER</span>
<span class="s">@app.route( &#39;/chooseQuestionToEdit&#39; )</span>
<span class="s">@login_required</span>
<span class="s">@user_permission.require()</span>
<span class="s">def chooseQuestionToEdit():</span>
<span class="s">#DIVIDER</span>
<span class="s">        TODO: Super-inefficient, but tries to cache questions for a generated quiz... &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">((</span><span class="s">&#39;classAbbr&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">global</span> <span class="n">g_CachedQuestions</span>
        <span class="n">quizzesFound</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">g_CachedQuestions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">g_CachedQuestions</span><span class="p">:</span>
            <span class="n">quizzesFound</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">quiz</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;chooseQuiz.html&#39;</span><span class="p">,</span> <span class="n">quizzes</span> <span class="o">=</span> <span class="n">quizzesFound</span><span class="p">,</span> <span class="n">finalExamAvailable</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">quizzesFound</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Choose Quiz for &quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseClass&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>CHOOSERS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>"Funneling" location to chose a class for a specific mode (write, edit, review)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&quot;/manageMedia&quot;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">manageMedia</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="s">&#39;classAbbr&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span>
                <span class="n">humanReadableName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">imageFromUploadedFile</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">humanReadableName</span><span class="p">,</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">classAbbr</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s">&#39;Saved: &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;manageMedia&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">))</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;uploadMedia.html&#39;</span><span class="p">,</span> <span class="n">allowedFileTypes</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ALLOWED_EXTENSIONS&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Upload File (Image)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseClass&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Primary point for editing a question which begins with choosing questions that</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ALLOWED_EXTENSIONS&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>exist for a previously chosen class.
   TODO: Allow admins to edit <em>all</em> questions. """
f (('classAbbr' in session) and (session['classAbbr'])):
   classInfo = ClassInfo.get( session['classAbbr'] )
   questions = []
   for instance in Question.query.filter( Question.classAbbr == session['classAbbr'] ).order_by( Question.id ):
       questions.append( instance )
   if ( len( questions ) &gt; 0 ):
       return render_template( 'chooseQuestion.html', questions = questions, \
                              title = "Choose Question to Edit for " + classInfo.classAbbr + "(" + classInfo.longName + ")" )
   else:
       flash( "%s, you don't have any questions to edit for %s!" % ( currentUserFirstName(), classInfo ) )
lif 'mode' in session:
   flash( "Please choose a class first." )
   return redirect( url_for( 'chooseClass', mode = session['mode'] ) )
lse:
   flash( "Please choose a task (e.g., 'review') first." )
   return redirect( url_for( 'index' ) )</p>
<p>route( '/chooseQuiz' )
n_required
n_permission.require()
hooseQuiz():
Choose from existing unique quiz numbers available</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Media upload</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/choseClass&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">choseClass</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Display uploaded media files, or upload a new one.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">argForClass</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="s">&#39;classAbbr&#39;</span> <span class="p">)</span>
        <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argForClass</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Write&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;writeQuestion&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Edit&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseQuestionToEdit&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Review&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;requestReviewQuestion&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Generate&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseQuiz&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Media&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;manageMedia&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Unknown mode choice: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>TODO: Filter (optimization) by classAbbr. """
f (('classAbbr' in session) and (session['classAbbr'])):
   classInfo = ClassInfo.get( session['classAbbr'] )
   images = []
   instances = Image.query.order_by( Image.id ).all()
   for instance in instances:
       instance.cacheByName()
       images.append( instance )
   if ( len( images ) &gt; 0 ):
       return render_template('manageMedia.html', \
                              title="Manage Media for " + session['classAbbr'] + " (" + classInfo.longName + ")", \
                              imagesToDisplay = images, \
                              isDebugging = app.config['DEBUG'] )
   else:
       flash( "%s, you don't have any images to edit for %s!" % ( currentUserFirstName(), classInfo ) )
lif 'mode' in session:
   flash( "Please choose a class first." )
   return redirect( url_for( 'chooseClass', mode = session['mode'] ) )
lse:
   flash( "Please choose a task (e.g., 'review') first." )
   return redirect( url_for( 'index' ) )</p>
<p>route( "/uploadMedia", methods=['GET', 'POST'] )
n_required
_permission.require()
ploadMedia():
Upload a file (image), encrypt it, and store it in the database.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/writeQuestion&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">writeQuestion</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">((</span><span class="s">&#39;classAbbr&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="p">(</span> <span class="n">created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">classAbbr</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">],</span> <span class="n">classID</span> <span class="o">=</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
        <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">=</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;editQuestion&quot;</span><span class="p">,</span> <span class="n">questionID</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;chooseClass&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/editQuestion&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">editQuestion</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">((</span><span class="s">&#39;classAbbr&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">assert</span> <span class="n">classInfo</span><span class="p">,</span> <span class="s">&quot;classInfo wasn&#39;t passed to editQuestion??&quot;</span>
        <span class="n">rawQuestionIDAsString</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="s">&#39;questionID&#39;</span> <span class="p">)</span>
        <span class="k">assert</span> <span class="n">rawQuestionIDAsString</span><span class="p">,</span> <span class="s">&quot;rawQuestionID wasn&#39;t passed to editQuestion??&quot;</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">rawQuestionIDAsString</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">question</span><span class="p">:</span>  <span class="c"># Can be None if there was a problem retrieving this question</span>
            <span class="n">question</span><span class="o">.</span><span class="n">decryptText</span><span class="p">()</span>
            <span class="n">similarQuestions</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">retrieveAndDecryptSimilarQuestions</span><span class="p">()</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">QuestionForm</span><span class="p">(</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">question</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;button&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;delete&#39;</span> <span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">classID</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">==</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="p">):</span>
                        <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">=</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">flash</span><span class="p">(</span> <span class="s">&#39;Question #</span><span class="si">%d</span><span class="s"> deleted.&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">offsetNumberFromClass</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;/&quot;</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
                    <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
                    <span class="n">question</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">question</span><span class="o">.</span><span class="n">encryptText</span><span class="p">(</span> <span class="n">encryptComments</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">flash</span><span class="p">(</span> <span class="s">&#39;Question #</span><span class="si">%d</span><span class="s"> saved.&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">offsetNumberFromClass</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Edit&#39;</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;editQuestion&quot;</span><span class="p">,</span> <span class="n">questionID</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span> <span class="s">&#39;There was a problem handling the form POST for Question ID:</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;editQuestion.html&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="p">,</span> <span class="n">similarQuestionsToDisplay</span> <span class="o">=</span> <span class="n">similarQuestions</span><span class="p">,</span> <span class="n">questionToDisplay</span> <span class="o">=</span> <span class="n">question</span><span class="p">,</span> \
                               <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> Question #</span><span class="si">%d</span><span class="s"> For </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">],</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">offsetNumberFromClass</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Unable to find Question ID: &quot;</span><span class="o">+</span><span class="n">rawQuestionIDAsString</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseQuestionToEdit&#39;</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;chooseClass&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>CHOSE-ERS &lt;-- Steps following choosers (above)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/requestReviewQuestion&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">requestReviewQuestion</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Once a class is chosen (above), redirect to the mode's page (etc. 'write'-&gt;editQuestion())</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">uneditable</span> <span class="ow">and</span> <span class="n">includes</span> <span class="n">editable</span> <span class="n">comment</span> <span class="n">sections</span><span class="o">.</span>
        <span class="n">TODO</span><span class="p">:</span> <span class="n">Show</span><span class="o">/</span><span class="n">hide</span> <span class="n">comment</span> <span class="n">sections</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    if ((&#39;classAbbr&#39; in session) and (session[&#39;classAbbr&#39;])):</span>
<span class="s">        classInfo = ClassInfo.get( session[&#39;classAbbr&#39;] )</span>
<span class="s">#DIVIDER</span>
<span class="s">        reviewQuestionIDAsString = request.args.get( &#39;questionID&#39; )</span>
<span class="s">        assert( reviewQuestionIDAsString ), &quot;reviewQuestionID wasn&#39;t passed to reviewQuestion&quot;</span>
<span class="s">        question = Question.get( int( reviewQuestionIDAsString ) )</span>
<span class="s">        if question:</span>
<span class="s">            question.decryptCommentText()</span>
<span class="s">            similarQuestions = question.retrieveAndDecryptSimilarQuestions()</span>
<span class="s">            form = ReviewQuestionForm( request.form, question )</span>
<span class="s">            if request.method == &#39;POST&#39;:</span>
<span class="s">                form.populate_obj( question )</span>
<span class="s">                question.modified = datetime.datetime.now()</span>
<span class="s">                question.encryptText( )</span>
<span class="s">                if ( request.form[&#39;button&#39;] == &#39;needswork&#39; ):</span>
<span class="s">                    question.addReviewer( g.user, False, app.config[&#39;REVIEWS_BEFORE_OK_TO_USE&#39;] )</span>
<span class="s">                    db.session.commit()</span>
<span class="s">                    return redirect( url_for( &quot;requestReviewQuestion&quot; ) )</span>
<span class="s">                else:</span>
<span class="s">                    question.addReviewer( g.user, True, app.config[&#39;REVIEWS_BEFORE_OK_TO_USE&#39;] )</span>
<span class="s">                    if form.validate():</span>
<span class="s">                        db.session.merge( question )</span>
<span class="s">                        db.session.commit()</span>
<span class="s">                        return redirect( url_for( &quot;requestReviewQuestion&quot; ) )</span>
<span class="s">                    else:</span>
<span class="s">                        flash( &#39;There was a problem handling the form POST for Question ID:</span><span class="si">%d</span><span class="s">&#39; % ( question.id ) )</span>
<span class="s">            reviewersSaidOK = [0]  # loop.index starts index at 1</span>
<span class="s">            for n in range( len( question.reviewers ) ):</span>
<span class="s">                reviewersSaidOK.append( question.isOKFlags &amp; 1 &lt;&lt; n )</span>
<span class="s">            return render_template( &#39;reviewQuestion.html&#39;, form = form, similarQuestionsToDisplay = similarQuestions, </span><span class="se">\</span>
<span class="s">                                   questionToDisplay = question.makeMarkedUpVersion(), </span><span class="se">\</span>
<span class="s">                                   title = &quot;</span><span class="si">%s</span><span class="s"> Question #</span><span class="si">%d</span><span class="s"> For </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot; % ( session[&#39;mode&#39;], ( question.offsetNumberFromClass( classInfo ) + 1 ), session[&#39;classAbbr&#39;], classInfo.longName ), </span><span class="se">\</span>
<span class="s">                                                                        reviewersSaidOKToDisplay = reviewersSaidOK )</span>
<span class="s">        else:</span>
<span class="s">            flash( &quot;Couldn&#39;t find question ID: </span><span class="si">%s</span><span class="s">??&quot; </span><span class="si">% r</span><span class="s">eviewQuestionIDAsString )</span>
<span class="s">    elif &#39;mode&#39; in session:</span>
<span class="s">        flash( &quot;Please choose a class first.&quot; )</span>
<span class="s">        return redirect( url_for( &#39;chooseClass&#39;, mode = session[&#39;mode&#39;] ) )</span>
<span class="s">    else:</span>
<span class="s">        flash( &quot;Please choose a task (e.g., &#39;review&#39;) first.&quot; )</span>
<span class="s">        return redirect( url_for( &#39;index&#39; ) )</span>
<span class="s">#DIVIDER</span>
<span class="s">@app.route( &#39;/generateQuiz&#39; )</span>
<span class="s">@login_required</span>
<span class="s">@admin_permission.require()</span>
<span class="s">def generateQuiz():</span>
<span class="s">    if ((&#39;classAbbr&#39; in session) and (session[&#39;classAbbr&#39;])):</span>
<span class="s">        classInfo = ClassInfo.get( session[&#39;classAbbr&#39;] )</span>
<span class="s">        if g_CachedQuestions:</span>
<span class="s">            quizNumber = request.args.get( &#39;quizID&#39; )</span>
<span class="s">            assert quizNumber, &quot;Generate quiz without a quiz number??&quot;</span>
<span class="s">            generatedQuiz, generatedID = Question.generateQuiz( classInfo, int( quizNumber ), g_CachedQuestions, app.config[&#39;MAX_NUMBER_OF_QUESTIONS&#39;] )</span>
<span class="s">            return render_template( &#39;generatedQuizOrExam.html&#39;, quizNumberToDisplay = quizNumber, generatedIDToDisplay = generatedID, </span><span class="se">\</span>
<span class="s">                               generatedQuestionsToDisplay = generatedQuiz, classInfoToDisplay = classInfo )</span>
<span class="s">        else:</span>
<span class="s">            flash( &quot;Please select a quiz first.&quot; )</span>
<span class="s">            return redirect( url_for( &#39;chooseQuiz&#39; ) )</span>
<span class="s">    else:</span>
<span class="s">        flash( &quot;Please choose a class first.&quot; )</span>
<span class="s">    return redirect( url_for( &#39;chooseClass&#39;, mode = session[&#39;mode&#39;] ) )</span>

<span class="s">@app.route( &#39;/generateExam&#39; )</span>
<span class="s">@login_required</span>
<span class="s">@admin_permission.require()</span>
<span class="s">def generateExam():</span>
<span class="s">    if ((&#39;classAbbr&#39; in session) and (session[&#39;classAbbr&#39;])):</span>
<span class="s">        if g_CachedQuestions:</span>
<span class="s">            classInfo = ClassInfo.get( session[&#39;classAbbr&#39;] )</span>
<span class="s">            generatedExam, generatedID = Question.generateFinalExam( classInfo, g_CachedQuestions )</span>
<span class="s">            return render_template( &#39;generatedQuizOrExam.html&#39;, generatedIDToDisplay = generatedID, </span><span class="se">\</span>
<span class="s">                                   generatedQuestionsToDisplay = generatedExam, classInfoToDisplay = classInfo )</span>
<span class="s">        else:</span>
<span class="s">            flash( &quot;Please select a quiz first.&quot; )</span>
<span class="s">            return redirect( url_for( &#39;chooseQuiz&#39; ) )</span>
<span class="s">    else:</span>
<span class="s">        flash( &quot;Please choose a class first.&quot; )</span>
<span class="s">    return redirect( url_for( &#39;chooseClass&#39;, mode = session[&#39;mode&#39;] ) )</span>

<span class="s">@app.route( &quot;/retrieveQuizOrExam&quot;, methods = [&#39;POST&#39;, &#39;GET&#39;] )</span>
<span class="s">@login_required</span>
<span class="s">@admin_permission.require()</span>
<span class="s">def retrieveQuizOrExam():</span>
<span class="s">#DIVIDER</span>
<span class="s">    Flask-Login token_loader callback.</span>
<span class="s">    The token_loader function asks this function to take the token that was</span>
<span class="s">    stored on the users computer process it to check if its valid and then</span>
<span class="s">    return a User Object if its valid or None if its not valid.</span>
<span class="s">#DIVIDER</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>TODO: Add confirmation!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Retrieve a question that's been least reviewed for a chosen class.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Least reviewed is found by looking for 0, 1, 2, etc. up to 10 prior reviews."""
f (('classAbbr' in session) and (session['classAbbr'])):
   classInfo = ClassInfo.get( session['classAbbr'] )
   if ( Question.query.filter( Question.classAbbr == session['classAbbr'] ).count() &gt; 0 ):
       questionsToReview = Question.query.filter( Question.classAbbr == session['classAbbr'] ).all()
       leastReviewed = app.config["REVIEWS_BEFORE_OK_TO_USE"]
       assert( leastReviewed &gt; -1 )
       for questionToReview in questionsToReview:
           numTimesReviewed = len( questionToReview.reviewers )
           if ( numTimesReviewed &lt; leastReviewed ):
               leastReviewed = numTimesReviewed
       leastReviewedQuestionsToReview = []
       for questionToReview in questionsToReview:
           numTimesReviewed = len( questionToReview.reviewers )
           if ( numTimesReviewed == leastReviewed ):
               leastReviewedQuestionsToReview.append( questionToReview )
           # We have a list of least reviewed questions, pick one at random.
       questionToReview = random.choice( leastReviewedQuestionsToReview )
       return redirect( url_for( 'reviewQuestion', questionID = questionToReview.id ) )
   flash( 'There are no questions to review for class: ' + classInfo.longName )
lse:
   flash( "Please choose a class first." )
eturn redirect( url_for( 'chooseClass', mode = session['mode'] ) )</p>
<p>route( '/reviewQuestion', methods = ['POST', 'GET'] )
n_required
_permission.require()
eviewQuestion():
Handler for the "Review question" functionality. Redisplays the original question text as</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Handle a question review form</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Retrieve and render a previous quiz or final exam given a code that is displayed on generated quizzes or finals.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>TODO: Fix "Quiz" or "Final Exam" titles """
f request.method == 'POST':
   code = request.form['code']
   questions, classInfo = Question.getQuestionsFromID( code  )
   messages = get_flashed_messages()
   if ( len( messages ) == 0 ):
       if ( len( questions ) == 0 ):
           flash ( "No valid questions found for code: %s??" % code )
           return redirect( url_for( 'retrieveQuizOrExam' ) )
       return render_template( 'generatedQuizOrExam.html', generatedIDToDisplay = code, \
                               generatedQuestionsToDisplay = questions, classInfoToDisplay = classInfo )
     else: # Re-push the flash messages (get_flashed_messages remove current flashes
         for message in messages:
             flash(message)
eturn render_template( 'retrieveQuizOrExam.html' )</p>
<p>route( "/imageStatistics" )
n_required
_permission.require()
mageStatistics():
awImageIDAsString = request.args.get( 'imageID' )
ssert rawImageIDAsString, "rawImageIDAsString wasn't passed to imageStatistics??"
mage = Image.get( int( rawImageIDAsString ) )
f image:  # Can be None if there was a problem retrieving this image
   return render_template( 'imageStatistics.html', title = "Image Statistics for "+image.name, imageToDisplay = image)
lse:
   flash("Unable to find Image ID: "+rawImageIDAsString)
   return redirect( url_for( 'manageMedia' ) )</p>
<p>IN</p>
<p>route( "/adminDatabaseReset" )
n_required
n_permission.require()
dminDatabaseReset():
mport db_reset
essageList = []
 for entry in Question.query.all():
     messageList.append( "Deleting Question id: %d (class id: %d) (%s)" % ( entry.id, entry.classID, entry.shortenedDecryptedQuestionWithMarkup() ) )
     db.session.delete( entry )
 for entry in User.query.filter( User.fullname != "Glenn Sugden" ).all():
     messageList.append( "Deleting User id: %d (%s)" % ( entry.id, entry.fullname ) )
     db.session.delete( entry )
 for entry in ClassInfo.query.all():
     messageList.append( "Resetting class ids for: %s (id: %d)" % ( entry.longName, entry.id ) )
     entry.currentID = entry.startingID
 db.session.commit()
b_reset.resetDatabase(db)
essageList.append( "...done!" )
eturn render_template( 'adminOutput.html', title = "Admin. - Database Reset", messagesToDisplay = messageList )</p>
<p>route( "/adminTesting" )
n_required
n_permission.require()
dminTesting():
essages = []
mage1=Image.getAndCacheByName("9f.3.1.gif")
essages.append(image1.cachePath)
mage2=Image.getAndCacheByName("9f.3.1.jpg")
essages.append(path2.cachePath)
ry:
   p = subprocess.Popen(["ls","/tmp"], stdout=subprocess.PIPE)
   result = p.communicate()[0]
   app.logger.debug(result)
   messages.append(result)
xcept OSError as ex:
   print "OSError({0}): {1}".format(ex.errno, ex.strerror)
essages.append(app.config['UPLOAD_FOLDER'])
eturn render_template("adminTesting.html", imagesToDisplay = [path1,path2], messageToDisplay = messages)</p>
<p>LITES</p>
<p>route( "/tmp/<path:path>" )
empPath( path ):
'' Shiv (to utils) to handle tmp/FILE URL requests. '''
 app.logger.debug(path)
esp = makeTempFileResp( path )
eturn resp</p>
<p>urrentUserFirstName():
f g.user:
   if g.user.fullname:
       return g.user.fullname.split( " " )[0]
   else:
       return "?? anonymous ??"
eturn "?? NO GLOBAL USER ??"</p>
<p>URITY</p>
<p>route( "/verifyUsers" )
n_required
n_permission.require()
erifyUsers():
nverifiedUsers = User.getAllUnverifiedUsers()
eturn render_template( 'verifyUsers.html', unverifiedUsers = unverifiedUsers )</p>
<p>route( "/verifyingUser" )
n_required
n_permission.require()
erifyingUser():
dAsString = request.args.get( 'id' )
ssert idAsString, "ID wasn't passed to verifyingUser??"
ser = User.query.filter( User.id == int( idAsString ) ).first()
f user:
   if ( user.is_verified() == False ):
       user_datastore = SQLAlchemyUserDatastore( db, User, Role )
       default_role = user_datastore.find_or_create_role( 'user' )
       user_datastore.add_role_to_user( user, default_role )
       db.session.merge( user )
       db.session.commit()
   else:
       flash( "User ID %s is already verified?" % ( idAsString ) )
lse:
   flash( "Couldn't find User ID %s to verify?" % ( idAsString ) )
eturn redirect( url_for( 'verifyUsers' ) )</p>
<p>route( "/unverifiedUser" )
n_required
_permission.require()
nverifiedUser():
eturn render_template( 'unverifiedUser.html',
   admins = getAdmins() )</p>
<p>ser_loader
oad_user( uid ):
eturn User.get( int( uid ) )</p>
<p>before_request
efore_request():
.user = current_user</p>
<p>tity_loaded.connect_via( app )
n_identity_loaded( sender, identity ):
 Set the identity user object
dentity.user = current_user</p>
<p>Add the UserNeed to the identity
f hasattr( current_user, 'id' ):
   identity.provides.add( UserNeed( current_user.id ) )</p>
<p>Assuming the User model has a list of roles, update the
 identity with the roles that the user provides
f hasattr( current_user, 'roles' ):
   for role in current_user.roles:
       identity.provides.add( RoleNeed( role.name ) )</p>
<p>his processor is added to only the register view
curity.register_context_processor
 security_register_processor():
 app.logger.debug("security_register_processor")</p>
<p>enerate_csrf_token():
pp.logger.debug( "generate_csrf_token" )
f '_csrf_token' not in session:
   session['_csrf_token'] = app.config['SECRET_KEY']
eturn session['_csrf_token']</p>
<p>oken_loader
oad_token( token ):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <h1>The Token itself was generated by User.get_auth_token.  So it is up to</h1>
<h1>us to known the format of the token data itself.</h1>
<h1>The Token was encrypted using itsdangerous.URLSafeTimedSerializer which</h1>
<h1>allows us to have a max_age on the token itself.  When the cookie is stored</h1>
<h1>on the users computer it also has a exipry date, but could be changed by</h1>
<h1>the user, so this feature allows us to enforce the exipry date of the token</h1>
<h1>server side and not rely on the users cookie to exipre.</h1>
<p>max_age = app.config["REMEMBER_COOKIE_DURATION"].total_seconds()</p>
<h1>Decrypt the Security Token, data = [username, hashpass]</h1>
<p>data = login_serializer.loads( token, max_age = max_age )</p>
<h1>Find the User</h1>
<p>user = User.get( data[0] )</p>
<h1>Check Password and return user or None</h1>
<p>if user and data[1] == user.password:
    return user
return None</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
