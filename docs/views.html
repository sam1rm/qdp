<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>views.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>views.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <h3><span id="imports" href="imports"> Imports </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">login_serializer</span><span class="p">,</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">flask.ext.mail</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">flask.ext.principal</span> <span class="kn">import</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">RoleNeed</span><span class="p">,</span> <span class="n">UserNeed</span><span class="p">,</span> <span class="n">identity_loaded</span>
<span class="kn">from</span> <span class="nn">flask.ext.security</span> <span class="kn">import</span> <span class="n">SQLAlchemyUserDatastore</span>
<span class="kn">from</span> <span class="nn">flask.helpers</span> <span class="kn">import</span> <span class="n">get_flashed_messages</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>

<span class="kn">from</span> <span class="nn">app.forms</span> <span class="kn">import</span> <span class="n">QuestionForm</span><span class="p">,</span> <span class="n">ReviewQuestionForm</span><span class="p">,</span> <span class="n">ReportForm</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">,</span> <span class="n">ClassInfo</span><span class="p">,</span> <span class="n">Question</span><span class="p">,</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">app.utils</span> <span class="kn">import</span> <span class="n">makeTempFileResp</span>
<span class="kn">from</span> <span class="nn">app.oracle</span> <span class="kn">import</span> <span class="n">generateIV</span><span class="p">,</span> <span class="n">encrypt</span>
<span class="kn">import</span> <span class="nn">db_reset</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h3><span id="globals" href="globals"> Globals </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">gCachedQuestions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">gHerokuPushVersion</span> <span class="o">=</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Create a permission with a single Need, in this case a RoleNeed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">user_permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="p">(</span> <span class="n">RoleNeed</span><span class="p">(</span> <span class="s">&#39;user&#39;</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">admin_permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="p">(</span> <span class="n">RoleNeed</span><span class="p">(</span> <span class="s">&#39;admin&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h3><span id="constants" href="constants"> Constants </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">CLASS_ABBR_KEY</span> <span class="o">=</span> <span class="s">&#39;classAbbr&#39;</span>
<span class="n">QUESTION_ID_KEY</span> <span class="o">=</span> <span class="s">&#39;questionID&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <h3><span id="view-code-begins" href="view-code-begins"> View Code Begins </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Top level site location. Displays additional buttons for admin: Verify users (if there are any), and provide additional administration.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>app.logger.debug("user=g.user")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>app.logger.debug("user.is_verified()")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_verified</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">gHerokuPushVersion</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gHerokuPushVersion</span><span class="p">:</span>
            <span class="n">fref</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;version.txt&quot;</span><span class="p">)</span>
            <span class="n">gHerokuPushVersion</span> <span class="o">=</span> <span class="n">fref</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>imageFileURL = url_for( 'static', filename = 'img/possibly47abc.png' )
app.logger.debug("render_template")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;index.html&#39;</span><span class="p">,</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span>
            <span class="n">isAdmin</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(),</span>
            <span class="n">hasUnverifiedUsers</span> <span class="o">=</span> <span class="p">(</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">()</span> <span class="ow">and</span> <span class="n">User</span><span class="o">.</span><span class="n">hasUnverifiedUsers</span><span class="p">()</span> <span class="p">),</span>  <span class="c"># redundant on purpose</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;helpMain&#39;</span><span class="p">,</span>
            <span class="n">isDebugging</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">],</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">gHerokuPushVersion</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>app.logger.debug("unverifiedUser")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;unverifiedUser&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Help page associated with the main page. TODO: Make help dynamic (e.g. <strong>page</strong>Help.html)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/helpMain&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">helpMain</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;helpMain.html&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;SAMPLE HELP PAGE&quot;</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>CHOOSERS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>"Funneling" location to chose a class for a specific mode (write, edit, review)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/chooseClass&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">chooseClass</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">argMode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="s">&#39;mode&#39;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">argMode</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argMode</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;chooseClass.html&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;: Choose Class&quot;</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Primary point for editing a question which begins with choosing questions that exist for a previously chosen class. TODO: Allow admins to edit <em>all</em> questions.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/chooseQuestionToEdit&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">chooseQuestionToEdit</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">CLASS_ABBR_KEY</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">()):</span>
            <span class="n">questions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span> <span class="n">Question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">questions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="n">Question</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span> <span class="n">Question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">questions</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>TODO: This is SUCH a hack .. clean up encrypted synchronization!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;chooseQuestion.html&#39;</span><span class="p">,</span> <span class="n">questions</span> <span class="o">=</span> <span class="n">questions</span><span class="p">,</span> \
                                   <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Choose Question to Edit for </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">classInfo</span><span class="o">.</span><span class="n">classAbbr</span><span class="p">,</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;You (</span><span class="si">%s</span><span class="s">) don&#39;t have any questions to edit for </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)!&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">currentUserFirstName</span><span class="p">(),</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">classAbbr</span><span class="p">,</span><span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseClass&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseClass&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Choose from existing unique quiz numbers available. TODO: Super-inefficient, but tries to cache questions for a generated quiz...</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/chooseQuiz&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">chooseQuiz</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">CLASS_ABBR_KEY</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">global</span> <span class="n">gCachedQuestions</span>
        <span class="n">quizzesFound</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">gCachedQuestions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">gCachedQuestions</span><span class="p">:</span>
            <span class="n">quizzesFound</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">quiz</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;chooseQuiz.html&#39;</span><span class="p">,</span> <span class="n">quizzes</span> <span class="o">=</span> <span class="n">quizzesFound</span><span class="p">,</span> <span class="n">finalExamAvailable</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">quizzesFound</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Choose Quiz for &quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseClass&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Media upload</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Display uploaded media files, or upload a new one. TODO: Filter (optimization) by classAbbr.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&quot;/manageMedia&quot;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">manageMedia</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">CLASS_ABBR_KEY</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span> <span class="n">Image</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">cacheByName</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">instance</span> <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">images</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">, you don&#39;t have any images to edit for </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)!&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">currentUserFirstName</span><span class="p">(),</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">classAbbr</span><span class="p">,</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;manageMedia.html&#39;</span><span class="p">,</span> \
                               <span class="n">title</span><span class="o">=</span><span class="s">&quot;Manage Media for &quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">,</span> \
                               <span class="n">imagesToDisplay</span> <span class="o">=</span> <span class="n">images</span><span class="p">,</span> \
                               <span class="n">isDebugging</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseClass&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Upload a file (image), encrypt it, and store it in the database.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&quot;/uploadMedia&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">uploadMedia</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">CLASS_ABBR_KEY</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>humanReadableName = request.form['name']</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                    <span class="n">filenameSecure</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">filenameSecure</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>image = Image.imageFromUploadedFile(file, filepath, humanReadableName, classInfo.classAbbr)
Create an (encrypted) Image instance from an image file. The file is saved first as a way
to translate from Flask's file upload to the database - TODO: This conversion may not be necessary. """</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                    <span class="n">fref</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">fref</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">fref</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">dataIV</span><span class="p">,</span><span class="n">dataIV64</span> <span class="o">=</span> <span class="n">generateIV</span><span class="p">();</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filenameSecure</span><span class="p">,</span> <span class="n">classAbbr</span><span class="o">=</span><span class="n">classInfo</span><span class="o">.</span><span class="n">classAbbr</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dataIV</span><span class="p">),</span> <span class="n">dataIV</span><span class="o">=</span><span class="n">dataIV64</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s">&#39;Saved: &#39;</span> <span class="o">+</span> <span class="n">filenameSecure</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;manageMedia&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filenameSecure</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Invalid upload (file). Only accepting (extensions): &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ALLOWED_EXTENSIONS&#39;</span><span class="p">]))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;manageMedia&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;uploadMedia.html&#39;</span><span class="p">,</span> <span class="n">allowedFileTypes</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ALLOWED_EXTENSIONS&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Upload File (Image)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseClass&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ALLOWED_EXTENSIONS&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>CHOSE-ERS &lt;-- Steps following choosers (above)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Once a class is chosen (above), redirect to the mode's page (etc. 'write'-&gt;editQuestion())</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/choseClass&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">choseClass</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">CLASS_ABBR_KEY</span> <span class="p">)</span> <span class="c"># Store the passed arg &#39;class abbreviate&#39; in the session</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Write&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;writeNewQuestion&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Edit&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseQuestionToEdit&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Review&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;requestReviewQuestion&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Generate&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseQuiz&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Media&quot;</span> <span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;manageMedia&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s">&quot;Unknown mode choice: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Handler for writeNewQuestion. TODO: Handle missing required fields much more gracefully...</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/writeNewQuestion&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">writeNewQuestion</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">CLASS_ABBR_KEY</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="p">(</span> <span class="n">created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">classAbbr</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">],</span> <span class="n">classID</span> <span class="o">=</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
        <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">=</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;editQuestion&quot;</span><span class="p">,</span> <span class="n">questionID</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;chooseClass&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/editQuestion&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">editQuestion</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span><span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">CLASS_ABBR_KEY</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])):</span>
            <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">rawQuestionIDAsString</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">QUESTION_ID_KEY</span> <span class="p">)</span>
            <span class="k">assert</span> <span class="n">rawQuestionIDAsString</span><span class="p">,</span> <span class="s">&quot;rawQuestionID wasn&#39;t passed to editQuestion??&quot;</span>
            <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">rawQuestionIDAsString</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">question</span><span class="p">:</span>  <span class="c"># Can be None if there was a problem retrieving this question</span>
                <span class="n">question</span><span class="o">.</span><span class="n">decryptText</span><span class="p">()</span>
                <span class="n">rowCounts</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">calculateRows</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>TODO: Handle bad questions (errors on next line) gracefully!
           similarQuestions = question.retrieveAndDecryptSimilarQuestions()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">form</span> <span class="o">=</span> <span class="n">QuestionForm</span><span class="p">(</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">question</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;editQuestion.html&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="p">,</span> \</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <pre><code>                               similarQuestionsToDisplay = similarQuestions, \
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                        <span class="n">questionToDisplay</span> <span class="o">=</span> <span class="n">question</span><span class="p">,</span> \
                                        <span class="n">rowCountsToDisplay</span> <span class="o">=</span> <span class="n">rowCounts</span><span class="p">,</span> \
                                        <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> Question #</span><span class="si">%d</span><span class="s"> For </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                            <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">],</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">offsetNumberFromClass</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">),</span> \
                                        <span class="n">classInfo</span><span class="o">.</span><span class="n">longName</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Unable to find Question ID: &quot;</span><span class="o">+</span><span class="n">rawQuestionIDAsString</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;chooseQuestionToEdit&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a class first.&quot;</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Please choose a task (e.g., &#39;review&#39;) first.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;index&#39;</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;chooseClass&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/saveQuestion&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">saveQuestion</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">CLASS_ABBR_KEY</span> <span class="ow">in</span> <span class="n">session</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">])):</span>
        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="n">CLASS_ABBR_KEY</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">assert</span> <span class="n">classInfo</span><span class="p">,</span> <span class="s">&quot;classInfo wasn&#39;t already stored for saveQuestion??&quot;</span>
        <span class="n">rawQuestionIDAsString</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">QUESTION_ID_KEY</span> <span class="p">)</span>
        <span class="k">assert</span> <span class="n">rawQuestionIDAsString</span><span class="p">,</span> <span class="s">&quot;rawQuestionID wasn&#39;t passed to saveQuestion??&quot;</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">rawQuestionIDAsString</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">QuestionForm</span><span class="p">(</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">question</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;button&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;delete&#39;</span> <span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>TODO: Add confirmation!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">classID</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">==</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="p">):</span>
                    <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">=</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">currentID</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">flash</span><span class="p">(</span> <span class="s">&#39;Question #</span><span class="si">%d</span><span class="s"> deleted.&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">offsetNumberFromClass</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;index&quot;</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
                <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
                <span class="k">assert</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span> <span class="n">rawQuestionIDAsString</span> <span class="p">),</span> <span class="s">&quot;question.id should be the same as int( rawQuestionIDAsString )!&quot;</span>
                <span class="n">question</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">question</span><span class="o">.</span><span class="n">encryptText</span><span class="p">(</span> <span class="n">encryptComments</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">question</span> <span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">flash</span><span class="p">(</span> <span class="s">&#39;Question #</span><span class="si">%d</span><span class="s"> saved.&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">offsetNumberFromClass</span><span class="p">(</span> <span class="n">classInfo</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Edit&#39;</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;editQuestion&quot;</span><span class="p">,</span> <span class="n">questionID</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span> <span class="s">&#39;There was a problem handling the form POST (save) for Question ID:</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&#39;There was a problem getting the classInfo for the session.&#39;</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&quot;editQuestion&quot;</span><span class="p">,</span> <span class="n">questionID</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Retrieve a question that's been least reviewed for a chosen class.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&#39;/requestReviewQuestion&#39;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">requestReviewQuestion</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Least reviewed is found by looking for 0, 1, 2, etc. up to 10 prior reviews."""
f ((CLASS_ABBR_KEY in session) and (session[CLASS_ABBR_KEY])):
   classInfo = ClassInfo.get( session[CLASS_ABBR_KEY] )
   if ( Question.query.filter( Question.classAbbr == session[CLASS_ABBR_KEY] ).count() &gt; 0 ):
       questionsToReview = Question.query.filter( Question.classAbbr == session[CLASS_ABBR_KEY] ).all()
       leastReviewed = app.config["REVIEWS_BEFORE_OK_TO_USE"]
       assert( leastReviewed &gt; -1 )
       for questionToReview in questionsToReview:
           numTimesReviewed = len( questionToReview.reviewers )
           if ( numTimesReviewed &lt; leastReviewed ):
               leastReviewed = numTimesReviewed
       leastReviewedQuestionsToReview = []
       for questionToReview in questionsToReview:
           numTimesReviewed = len( questionToReview.reviewers )
           if ( numTimesReviewed == leastReviewed ):
               leastReviewedQuestionsToReview.append( questionToReview )
           # We have a list of least reviewed questions, pick one at random.
       questionToReview = random.choice( leastReviewedQuestionsToReview )
       return redirect( url_for( 'reviewQuestion', questionID = questionToReview.id ) )
   flash( 'There are no questions to review for class: ' + classInfo.longName )
lse:
   flash( "Please choose a class first." )
eturn redirect( url_for( 'chooseClass', mode = session['mode'] ) )</p>
<p>route( '/reviewQuestion', methods = ['POST', 'GET'] )
n_required
_permission.require()
eviewQuestion():
Handler for the "Review question" functionality. Redisplays the original question text as</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">uneditable</span> <span class="ow">and</span> <span class="n">includes</span> <span class="n">editable</span> <span class="n">comment</span> <span class="n">sections</span><span class="o">.</span>
        <span class="n">TODO</span><span class="p">:</span> <span class="n">Show</span><span class="o">/</span><span class="n">hide</span> <span class="n">comment</span> <span class="n">sections</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    if ((CLASS_ABBR_KEY in session) and (session[CLASS_ABBR_KEY])):</span>
<span class="s">        classInfo = ClassInfo.get( session[CLASS_ABBR_KEY] )</span>
<span class="s">#DIVIDER</span>
<span class="s">        reviewQuestionIDAsString = request.args.get( QUESTION_ID_KEY )</span>
<span class="s">        assert( reviewQuestionIDAsString ), &quot;reviewQuestionID wasn&#39;t passed to reviewQuestion&quot;</span>
<span class="s">        question = Question.get( int( reviewQuestionIDAsString ) )</span>
<span class="s">        if question:</span>
<span class="s">            question.decryptCommentText()</span>
<span class="s">            rowCounts = question.calculateRows()</span>
<span class="s">#DIVIDER</span>
<span class="s">            form = ReviewQuestionForm( request.form, question )</span>
<span class="s">            if request.method == &#39;POST&#39;:</span>
<span class="s">                form.populate_obj( question )</span>
<span class="s">                question.modified = datetime.datetime.now()</span>
<span class="s">                question.encryptText( )</span>
<span class="s">                if ( request.form[&#39;button&#39;] == &#39;needswork&#39; ):</span>
<span class="s">                    question.addReviewer( g.user, False, app.config[&#39;REVIEWS_BEFORE_OK_TO_USE&#39;] )</span>
<span class="s">                    db.session.commit()</span>
<span class="s">                    return redirect( url_for( &quot;requestReviewQuestion&quot; ) )</span>
<span class="s">                else:</span>
<span class="s">                    question.addReviewer( g.user, True, app.config[&#39;REVIEWS_BEFORE_OK_TO_USE&#39;] )</span>
<span class="s">                    if form.validate():</span>
<span class="s">                        db.session.merge( question )</span>
<span class="s">                        db.session.commit()</span>
<span class="s">                        return redirect( url_for( &quot;requestReviewQuestion&quot; ) )</span>
<span class="s">                    else:</span>
<span class="s">                        flash( &#39;There was a problem handling the form POST for Question ID:</span><span class="si">%d</span><span class="s">&#39; % ( question.id ) )</span>
<span class="s">            reviewersSaidOK = [0]  # loop.index starts index at 1</span>
<span class="s">            for n in range( len( question.reviewers ) ):</span>
<span class="s">                reviewersSaidOK.append( question.isOKFlags &amp; 1 &lt;&lt; n )</span>
<span class="s">            return render_template( &#39;reviewQuestion.html&#39;, </span><span class="se">\</span>
<span class="s">                                    form = form, </span><span class="se">\</span>
<span class="s">#DIVIDER</span>
<span class="s">                                    questionToDisplay = question.makeMarkedUpVersion(), </span><span class="se">\</span>
<span class="s">                                    rowCountsToDisplay = rowCounts, </span><span class="se">\</span>
<span class="s">                                    title = &quot;</span><span class="si">%s</span><span class="s"> Question #</span><span class="si">%d</span><span class="s"> For </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot; % </span><span class="se">\</span>
<span class="s">                                        ( session[&#39;mode&#39;], ( question.offsetNumberFromClass( classInfo ) + 1 ), session[CLASS_ABBR_KEY], classInfo.longName ), </span><span class="se">\</span>
<span class="s">                                    reviewersSaidOKToDisplay = reviewersSaidOK )</span>
<span class="s">        else:</span>
<span class="s">            flash( &quot;Couldn&#39;t find question ID: </span><span class="si">%s</span><span class="s">??&quot; </span><span class="si">% r</span><span class="s">eviewQuestionIDAsString )</span>
<span class="s">    elif &#39;mode&#39; in session:</span>
<span class="s">        flash( &quot;Please choose a class first.&quot; )</span>
<span class="s">        return redirect( url_for( &#39;chooseClass&#39;, mode = session[&#39;mode&#39;] ) )</span>
<span class="s">    else:</span>
<span class="s">        flash( &quot;Please choose a task (e.g., &#39;review&#39;) first.&quot; )</span>
<span class="s">        return redirect( url_for( &#39;index&#39; ) )</span>
<span class="s">#DIVIDER</span>
<span class="s">@app.route( &#39;/gatherSimilarQuestionsFromTags&#39;, methods = [&#39;POST&#39;] )</span>
<span class="s">@login_required</span>
<span class="s">@user_permission.require()</span>
<span class="s">def gatherSimilarQuestionsFromTags():</span>
<span class="s">    if ((CLASS_ABBR_KEY in session) and (session[CLASS_ABBR_KEY])):</span>
<span class="s">        assert(request.form[ QUESTION_ID_KEY ] and request.form[ &#39;tags&#39; ] and request.form[ &#39;quiz&#39; ])  # Ensure that this data has been passed by the Javascript</span>
<span class="s">        classAbbr = session[CLASS_ABBR_KEY]</span>
<span class="s">        assert(classAbbr)</span>
<span class="s">        thisQuestionIDAsString = request.form[ QUESTION_ID_KEY ]</span>
<span class="s">        thisQuestionID = int(thisQuestionIDAsString)</span>
<span class="s">        tags=request.form[&#39;tags&#39;]</span>
<span class="s">        quizAsString=request.form[&#39;quiz&#39;]</span>
<span class="s">        quiz=int(quizAsString)</span>
<span class="s">        similarQuestions = Question.retrieveAndDecryptSimilarQuestions( thisQuestionID, tags, classAbbr, quiz )</span>
<span class="s">        return render_template( &#39;similarQuestions.html&#39;, similarQuestionsToDisplay=similarQuestions )</span>
<span class="s">    elif &#39;mode&#39; in session:</span>
<span class="s">            flash( &quot;Please choose a class first.&quot; )</span>
<span class="s">            return redirect( url_for( &#39;chooseClass&#39;, mode = session[&#39;mode&#39;] ) )</span>
<span class="s">    else:</span>
<span class="s">        flash( &quot;Please choose a task (e.g., &#39;review&#39;) first.&quot; )</span>
<span class="s">        return redirect( url_for( &#39;index&#39; ) )</span>
<span class="s">        </span>
<span class="s">@app.route( &#39;/generateQuiz&#39; )</span>
<span class="s">@login_required</span>
<span class="s">@admin_permission.require()</span>
<span class="s">def generateQuiz():</span>
<span class="s">#DIVIDER</span>
<span class="s">    if ((CLASS_ABBR_KEY in session) and (session[CLASS_ABBR_KEY])):</span>
<span class="s">        if gCachedQuestions:</span>
<span class="s">            classInfo = ClassInfo.get( session[CLASS_ABBR_KEY] )</span>
<span class="s">            generatedExam, generatedID = Question.generateFinalExam( classInfo, gCachedQuestions )</span>
<span class="s">            return render_template( &#39;generatedQuizOrExam.html&#39;, quizNumberToDisplay = 0,</span><span class="se">\</span>
<span class="s">                                    generatedIDToDisplay = generatedID, </span><span class="se">\</span>
<span class="s">                                    generatedQuestionsToDisplay = generatedExam, </span><span class="se">\</span>
<span class="s">                                    classInfoToDisplay = classInfo )</span>
<span class="s">        else:</span>
<span class="s">            flash( &quot;Please select a quiz # or final first.&quot; )</span>
<span class="s">            return redirect( url_for( &#39;chooseQuiz&#39; ) )</span>
<span class="s">    else:</span>
<span class="s">        flash( &quot;Please choose a class first.&quot; )</span>
<span class="s">    return redirect( url_for( &#39;chooseClass&#39;, mode = session[&#39;mode&#39;] ) )</span>
<span class="s">#DIVIDER</span>
<span class="s">@app.route( &quot;/retrieveQuizOrExam&quot;, methods = [&#39;POST&#39;, &#39;GET&#39;] )</span>
<span class="s">@login_required</span>
<span class="s">@admin_permission.require()</span>
<span class="s">def retrieveQuizOrExam():</span>
<span class="s">#DIVIDER</span>
<span class="s">        TODO: Replaced with email, for now, because the registration module doesn&#39;t yet ask for full name. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Handle a question review form</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">return</span> <span class="s">&quot;?? anonymous ??&quot;</span>
    <span class="k">return</span> <span class="s">&quot;?? NO GLOBAL USER ??&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>similarQuestions = question.retrieveAndDecryptSimilarQuestions()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>similarQuestionsToDisplay = similarQuestions, \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&quot;/verifyUsers&quot;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">verifyUsers</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Generate a printable quiz (see Question.generateQuiz for more information). Utilizes questions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">unverifiedUsers</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">getAllUnverifiedUsers</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;verifyUsers.html&#39;</span><span class="p">,</span> <span class="n">unverifiedUsers</span> <span class="o">=</span> <span class="n">unverifiedUsers</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>hat were previously cached when choosing which quiz to generate (See chooseQuiz (above) for more 
nformation. The quiz itself is rendered on a new page (to ease printing). """ 
f ((CLASS_ABBR_KEY in session) and (session[CLASS_ABBR_KEY])):
   classInfo = ClassInfo.get( session[CLASS_ABBR_KEY] )
   if gCachedQuestions:
       quizNumber = request.args.get( 'quizID' )
       assert quizNumber, "Generate quiz without a quiz number??"
       generatedQuiz, generatedID = Question.generateQuiz( classInfo, int( quizNumber ), gCachedQuestions, app.config['MAX_NUMBER_OF_QUESTIONS'] )
       return render_template( 'generatedQuizOrExam.html', quizNumberToDisplay = quizNumber, generatedIDToDisplay = generatedID, \
                          generatedQuestionsToDisplay = generatedQuiz, classInfoToDisplay = classInfo )
   else:
       flash( "Please select a quiz first." )
       return redirect( url_for( 'chooseQuiz' ) )
lse:
   flash( "Please choose a class first." )
eturn redirect( url_for( 'chooseClass', mode = session['mode'] ) )</p>
<p>route( '/generateExam' )
n_required
n_permission.require()
enerateExam():
Very similar to generateQuiz (above), except uses Question.generateFinalExam</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span> <span class="s">&quot;/verifyingUser&quot;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">verifyingUser</span><span class="p">():</span>
    <span class="n">idAsString</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="s">&#39;id&#39;</span> <span class="p">)</span>
    <span class="k">assert</span> <span class="n">idAsString</span><span class="p">,</span> <span class="s">&quot;ID wasn&#39;t passed to verifyingUser??&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span> <span class="n">idAsString</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">user</span><span class="o">.</span><span class="n">is_verified</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span> <span class="p">):</span>
            <span class="n">user_datastore</span> <span class="o">=</span> <span class="n">SQLAlchemyUserDatastore</span><span class="p">(</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span> <span class="p">)</span>
            <span class="n">default_role</span> <span class="o">=</span> <span class="n">user_datastore</span><span class="o">.</span><span class="n">find_or_create_role</span><span class="p">(</span> <span class="s">&#39;user&#39;</span> <span class="p">)</span>
            <span class="n">user_datastore</span><span class="o">.</span><span class="n">add_role_to_user</span><span class="p">(</span> <span class="n">user</span><span class="p">,</span> <span class="n">default_role</span> <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">user</span> <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;User ID </span><span class="si">%s</span><span class="s"> is already verified?&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">idAsString</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span> <span class="s">&quot;Couldn&#39;t find User ID </span><span class="si">%s</span><span class="s"> to verify?&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">idAsString</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span> <span class="n">url_for</span><span class="p">(</span> <span class="s">&#39;verifyUsers&#39;</span> <span class="p">)</span> <span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span> <span class="s">&quot;/unverifiedUser&quot;</span> <span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">unverifiedUser</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span> <span class="s">&#39;unverifiedUser.html&#39;</span><span class="p">,</span>
        <span class="n">admins</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">getAllAdmins</span><span class="p">()</span> <span class="p">)</span>

<span class="nd">@lm.user_loader</span>
<span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span> <span class="n">uid</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">uid</span> <span class="p">)</span> <span class="p">)</span>

<span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>

<span class="nd">@identity_loaded.connect_via</span><span class="p">(</span> <span class="n">app</span> <span class="p">)</span>
<span class="k">def</span> <span class="nf">on_identity_loaded</span><span class="p">(</span> <span class="n">sender</span><span class="p">,</span> <span class="n">identity</span> <span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Retrieve and render a previous quiz or final exam given a code that is displayed on generated quizzes or finals.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">identity</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>TODO: Fix "Quiz" or "Final Exam" titles """
f request.method == 'POST':
   code = request.form['code']
   questions, classInfo = Question.getQuestionsFromID( code  )
   messages = get_flashed_messages()
   if ( len( messages ) == 0 ):
       if ( len( questions ) == 0 ):
           flash ( "No valid questions found for code: %s??" % code )
           return redirect( url_for( 'retrieveQuizOrExam' ) )
       return render_template( 'generatedQuizOrExam.html', generatedIDToDisplay = code, \
                               generatedQuestionsToDisplay = questions, classInfoToDisplay = classInfo )
     else: # Re-push the flash messages (get_flashed_messages remove current flashes
         for message in messages:
             flash(message)
eturn render_template( 'retrieveQuizOrExam.html' )</p>
<p>route( "/imageStatistics" )
n_required
_permission.require()
mageStatistics():
awImageIDAsString = request.args.get( 'imageID' )
ssert rawImageIDAsString, "rawImageIDAsString wasn't passed to imageStatistics??"
mage = Image.get( int( rawImageIDAsString ) )
f image:  # Can be None if there was a problem retrieving this image
   try:
       image.cacheByName()
   except Exception as ex:
       flash(image.filename + ": " +  str(ex))
   return render_template( 'imageStatistics.html', title = "Image Statistics for "+image.filename, imageToDisplay = image)
lse:
   flash("Unable to find Image ID: "+rawImageIDAsString)
   return redirect( url_for( 'manageMedia' ) )</p>
<p>IN</p>
<p>route( "/adminDatabaseReset" )
n_required
n_permission.require()
dminDatabaseReset():
ry:
   messages = db_reset.resetDatabase(db)
xcept Exception as ex:
   messages = ["An exception occurred while resetting the database:"]
   if (str(ex)):
       messages.append(str(ex))
   formattedExceptionLines = traceback.format_exc().split("\n")
   for line in formattedExceptionLines:
       if (len(line)&gt;0):
           messages.append(line)
flash("Database resetteded!")
eturn render_template("adminOutput.html", messagesToDisplay = messages)</p>
<p>route( "/adminTesting" )
n_required
n_permission.require()
dminTesting():
essages = []
mage1=Image.getAndCacheByName("9f.3.1.gif")
essages.append(image1.cachePath)
mage2=Image.getAndCacheByName("9f.3.1.jpg")
essages.append(path2.cachePath)
ry:
   p = subprocess.Popen(["ls","/tmp"], stdout=subprocess.PIPE)
   result = p.communicate()[0]
   app.logger.debug(result)
   messages.append(result)
xcept OSError as ex:
   print "OSError({0}): {1}".format(ex.errno, ex.strerror)
essages.append(app.config['UPLOAD_FOLDER'])
eturn render_template("adminTesting.html", imagesToDisplay = [path1,path2], messageToDisplay = messages)</p>
<p>Report a Bug ===</p>
<p>route( "/reporting" )
eporting():
eturnTo = request.args.get( 'returnTo' )
orm = ReportForm(who=currentUserFirstName(),when=datetime.datetime.now())
eturn render_template("reporting.html", form=form, returnToParam = returnTo)</p>
<p>route( "/sendOrDeleteReport", methods = ['POST'] )
endOrDeleteReport():
eturnTo = request.args.get( 'returnTo' )
f request.method == 'POST':
   if ( request.form['button'] == 'delete' ):
       flash( 'Report cancelled')
   else:
       msg = Message("QDP BUG REPORT",
                     body="Who: %s\nWhen: %s\nWhere: %s\nReport: %s\n\nSesson: %s" % \
                       (request.form['who'], request.form['when'], returnTo, request.form['report'], session),
                     sender=g.user.email,
                     recipients=["headcrash@berkeley.edu"])
       mail.send(msg)
       flash( 'Report sent! Thank you!')
return redirect( returnTo )
eturn redirect( url_for( 'index' ) ) # Return to top, as request.args may be incorrect at this point (e.g. reviewQuestion and questionID)</p>
<p>route("/downloadDatabase")
n_required
n_permission.require()
ownloadDatabase():
 Check for valid file and assign it to <code>inbound_file</code>
_in = open('app.db', 'rb')
_out = gzip.open('/tmp/app.db.gz', 'wb')
_out.writelines(f_in)
_out.close()
_in.close()
esp = makeTempFileResp("app.db.gz")
eturn resp</p>
<p>UTILITES ===</p>
<p>route( "/tmp/<path:path>" )
empPath( path ):
'' Shiv (to utils) to handle tmp/FILE URL requests (used for images). '''
esp = makeTempFileResp( path )
eturn resp</p>
<p>urrentUserFirstName():
Helper function to return the full name associated with the currently logged in user.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">current_user</span><span class="p">,</span> <span class="s">&#39;id&#39;</span> <span class="p">):</span>
        <span class="n">identity</span><span class="o">.</span><span class="n">provides</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">UserNeed</span><span class="p">(</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <pre><code>    if g.user.fullname:
        return g.user.fullname.split( " " )[0]
    else:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">current_user</span><span class="p">,</span> <span class="s">&#39;roles&#39;</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="n">identity</span><span class="o">.</span><span class="n">provides</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">RoleNeed</span><span class="p">(</span> <span class="n">role</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>SECURITY</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Admin page for verifying users that have successfully registered.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_csrf_token</span><span class="p">():</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;generate_csrf_token&quot;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;_csrf_token&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s">&#39;_csrf_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;_csrf_token&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@lm.token_loader</span>
<span class="k">def</span> <span class="nf">load_token</span><span class="p">(</span> <span class="n">token</span> <span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>Set the identity user object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Add the UserNeed to the identity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">max_age</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;REMEMBER_COOKIE_DURATION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Assuming the User model has a list of roles, update the
identity with the roles that the user provides</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">data</span> <span class="o">=</span> <span class="n">login_serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span> <span class="n">token</span><span class="p">,</span> <span class="n">max_age</span> <span class="o">=</span> <span class="n">max_age</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>This processor is added to only the register view
@security.register_context_processor
def security_register_processor():
    app.logger.debug("security_register_processor")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span>
    <span class="k">return</span> <span class="bp">None</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Flask-Login token_loader callback.
The token_loader function asks this function to take the token that was
stored on the users computer process it to check if its valid and then
return a User Object if its valid or None if its not valid.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>The Token itself was generated by User.get_auth_token.  So it is up to
us to known the format of the token data itself.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>The Token was encrypted using itsdangerous.URLSafeTimedSerializer which
allows us to have a max_age on the token itself.  When the cookie is stored
on the users computer it also has a exipry date, but could be changed by
the user, so this feature allows us to enforce the exipry date of the token
server side and not rely on the users cookie to exipre.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>Decrypt the Security Token, data = [username, hashpass]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>Find the User</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>Check Password and return user or None</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
