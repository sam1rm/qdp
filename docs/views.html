<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>views.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>views.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">login_serializer</span>
<span class="kn">from</span> <span class="nn">app.forms</span> <span class="kn">import</span> <span class="n">QuestionForm</span><span class="p">,</span> <span class="n">ReviewQuestionForm</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">,</span> <span class="n">ClassInfo</span><span class="p">,</span> <span class="n">Question</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">login_user</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">flask.ext.principal</span> <span class="kn">import</span> <span class="n">Principal</span><span class="p">,</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">RoleNeed</span><span class="p">,</span> <span class="n">UserNeed</span><span class="p">,</span> <span class="n">identity_loaded</span>
<span class="kn">from</span> <span class="nn">flask.ext.security</span> <span class="kn">import</span> <span class="n">Security</span><span class="p">,</span> <span class="n">SQLAlchemyUserDatastore</span>
<span class="kn">import</span> <span class="nn">random</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Create a permission with a single Need, in this case a RoleNeed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">user_permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="p">(</span><span class="n">RoleNeed</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">))</span>
<span class="n">admin_permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="p">(</span><span class="n">RoleNeed</span><span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Top level location &#39;&#39;&#39;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_verified</span><span class="p">():</span>
        <span class="n">unverifiedUsers</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">()):</span>
            <span class="n">unverifiedUsers</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">getAllUnverified</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span>
            <span class="n">superuserAndUnverifiedUsers</span> <span class="o">=</span> <span class="n">unverifiedUsers</span><span class="p">,</span>
            <span class="n">helpfileurl</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;helpMain&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;unverifiedUser&#39;</span><span class="p">))</span>
        
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/helpMain&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">helpMain</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Help page associated with the main page.</span>
<span class="sd">        TODO: Make help dynamic (e.g. __page__Help.html)&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;helpMain.html&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h6></h6>
<p>CHOOSERS #</p>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/chooseClass&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">chooseClass</span><span class="p">():</span>
     <span class="sd">&#39;&#39;&#39; &quot;Funneling&quot; location to chose a class for a specific mode (write, edit, review) &#39;&#39;&#39;</span>
     <span class="n">argMode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">)</span>
     <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">argMode</span>
     <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;chooseClass.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;: Choose Class&quot;</span> <span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/chooseQuestionToEdit&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">chooseQuestionToEdit</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Primary point for editing a question which begins with choosing questions that </span>
<span class="sd">        exist for a previously chosen class.</span>
<span class="sd">        TODO: Allow admins to edit _all_ questions. &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">],</span><span class="s">&quot;Couldn&#39;t find previous class info for class: </span><span class="si">%s</span><span class="s">??&quot;</span> <span class="o">%</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span>
    <span class="n">questions</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">id</span><span class="p">):</span> 
        <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">, you don&#39;t have any questions to edit for class </span><span class="si">%s</span><span class="s">!&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">currentUserFirstName</span><span class="p">(),</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">longName</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;chooseQuestion.html&#39;</span><span class="p">,</span> <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="p">,</span> \
                           <span class="n">title</span><span class="o">=</span><span class="s">&quot;Choose Question to Edit for &quot;</span><span class="o">+</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="o">+</span><span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">longName</span> <span class="o">+</span><span class="s">&quot;)&quot;</span> <span class="p">)</span>

<span class="n">cachedQuestions</span><span class="o">=</span><span class="p">[]</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/chooseQuiz&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">chooseQuiz</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Choose from existing unique quiz numbers available</span>
<span class="sd">        TODO: Super-inefficient, but tries to cache questions for a generated quiz... &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">cachedQuestions</span>
    <span class="n">quizzesFound</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">cachedQuestions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">cachedQuestions</span><span class="p">:</span>
         <span class="n">quizzesFound</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">quiz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;chooseQuiz.html&#39;</span><span class="p">,</span> <span class="n">quizzes</span> <span class="o">=</span> <span class="n">quizzesFound</span><span class="p">,</span> <span class="n">finalExamAvailable</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quizzesFound</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Choose Quiz For &quot;</span><span class="o">+</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="o">+</span><span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">longName</span> <span class="o">+</span><span class="s">&quot;)&quot;</span> <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <h6></h6>
<p>CHOSE-ERS # &lt;-- Steps following choosers (above)</p>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/choseClass&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">choseClass</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Once a class is chosen (above), redirect to the mode&#39;s page (etc. &#39;write&#39;-&gt;editQuestion()) &#39;&#39;&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <pre><code>assert(request.args.get('mode')==session['mode']),"request.args 'mode' (%s) != session['mode'] (%s)"    \
    %(request.args.get('mode'),session['mode'])
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">argForClass</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;classAbbr&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">argForClass</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">],</span><span class="s">&quot;Couldn&#39;t find class info for class: </span><span class="si">%s</span><span class="s">??&quot;</span> <span class="o">%</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Write&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;writeQuestion&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Edit&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseQuestionToEdit&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Review&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;requestReviewQuestion&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Generate&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseQuiz&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unknown mode choice: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/writeQuestion&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">writeQuestion</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span> <span class="p">):</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="p">(</span><span class="n">created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">classAbbr</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">],</span> <span class="n">classID</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">currentID</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;editQuestion&quot;</span><span class="p">,</span><span class="n">questionID</span><span class="o">=</span><span class="n">Question</span><span class="o">.</span><span class="n">idFromNumber</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please choose a class first.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;chooseClass&quot;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span>
    
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/editQuestion&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">editQuestion</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span> <span class="p">):</span>
        <span class="n">editQuestionID</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;questionID&#39;</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">editQuestionID</span><span class="p">),</span><span class="s">&quot;editQuestionID (</span><span class="si">%d</span><span class="s">) wasn&#39;t passed to editQuestion??&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">editQuestionID</span><span class="p">)</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">editQuestionID</span><span class="p">)</span>
        <span class="n">similarQuestions</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">getSimilarQuestions</span><span class="p">()</span>
        <span class="n">question</span><span class="o">.</span><span class="n">decryptQuestionText</span><span class="p">(</span><span class="n">questionOnly</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">QuestionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">question</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;button&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;delete&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>TODO: Add confirmation!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">classID</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">currentID</span><span class="p">):</span>
                    <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">currentID</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">currentID</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">])</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">flash</span><span class="p">(</span><span class="s">&#39;Question #</span><span class="si">%d</span><span class="s"> deleted.&#39;</span><span class="o">%</span> <span class="n">question</span><span class="o">.</span><span class="n">number</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;chooseQuestionToEdit&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
                <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                <span class="n">question</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">question</span><span class="o">.</span><span class="n">encryptQuestionText</span><span class="p">(</span><span class="n">questionOnly</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">currentID</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">currentID</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">])</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">flash</span><span class="p">(</span><span class="s">&#39;Question #</span><span class="si">%d</span><span class="s"> saved.&#39;</span> <span class="o">%</span> <span class="n">question</span><span class="o">.</span><span class="n">number</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Edit&#39;</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;editQuestion&quot;</span><span class="p">,</span><span class="n">questionID</span><span class="o">=</span><span class="n">Question</span><span class="o">.</span><span class="n">idFromNumber</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="s">&#39;There was a problem handling the form POST for Question ID:</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;editQuestion.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">similarQuestionsToDisplay</span><span class="o">=</span><span class="n">similarQuestions</span><span class="p">,</span> <span class="n">questionToDisplay</span><span class="o">=</span><span class="n">question</span><span class="p">,</span>   \
                               <span class="n">title</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> Question #</span><span class="si">%d</span><span class="s"> For </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">],</span> <span class="n">question</span><span class="o">.</span><span class="n">number</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">longName</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please choose a class first.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;chooseClass&quot;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/requestReviewQuestion&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">requestReviewQuestion</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Retrieve a question that&#39;s been least reviewed for a chosen class.</span>
<span class="sd">        Least reviewed is found by looking for 0, 1, 2, etc. up to 10 prior reviews.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span> <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">questionsToReview</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">classAbbr</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">leastReviewed</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;REVIEWS_BEFORE_OK_TO_USE&quot;</span><span class="p">]</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">leastReviewed</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">questionToReview</span> <span class="ow">in</span> <span class="n">questionsToReview</span><span class="p">:</span>
                <span class="n">numTimesReviewed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">questionToReview</span><span class="o">.</span><span class="n">reviewers</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">numTimesReviewed</span> <span class="o">&lt;</span> <span class="n">leastReviewed</span><span class="p">):</span>
                    <span class="n">leastReviewed</span> <span class="o">=</span> <span class="n">numTimesReviewed</span>
            <span class="n">leastReviewedQuestionsToReview</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">questionToReview</span> <span class="ow">in</span> <span class="n">questionsToReview</span><span class="p">:</span>
                <span class="n">numTimesReviewed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">questionToReview</span><span class="o">.</span><span class="n">reviewers</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">numTimesReviewed</span> <span class="o">==</span> <span class="n">leastReviewed</span><span class="p">):</span>
                    <span class="n">leastReviewedQuestionsToReview</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">questionToReview</span><span class="p">)</span>
                <span class="sd">&#39;&#39;&#39; We have a list of least reviewed questions, pick one at random. &#39;&#39;&#39;</span>
            <span class="n">questionToReview</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">leastReviewedQuestionsToReview</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;reviewQuestion&#39;</span><span class="p">,</span><span class="n">questionID</span><span class="o">=</span><span class="n">questionToReview</span><span class="o">.</span><span class="n">classID</span><span class="p">))</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&#39;There are no questions to review for class: &#39;</span><span class="o">+</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">longName</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please choose a class first.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseClass&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/reviewQuestion&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">reviewQuestion</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; Handler for the &quot;Review question&quot; functionality. Redisplays the original question text as</span>
<span class="sd">        uneditable and includes comment sections.</span>
<span class="sd">        TODO: Show/hide comment sections&#39;&#39;&#39;</span> 
    <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Handle a question review form &#39;&#39;&#39;</span>
        <span class="n">reviewQuestionID</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;questionID&#39;</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">reviewQuestionID</span><span class="p">),</span><span class="s">&quot;reviewQuestionID (</span><span class="si">%d</span><span class="s">) wasn&#39;t passed to reviewQuestion&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reviewQuestionID</span><span class="p">)</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reviewQuestionID</span><span class="p">)</span>
        <span class="n">similarQuestions</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">getSimilarQuestions</span><span class="p">()</span>
        <span class="n">question</span><span class="o">.</span><span class="n">decryptQuestionText</span><span class="p">(</span><span class="n">commentsOnly</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReviewQuestionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">question</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">user</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">question</span><span class="o">.</span><span class="n">reviewers</span><span class="p">):</span>
                <span class="n">question</span><span class="o">.</span><span class="n">reviewers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">question</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">question</span><span class="o">.</span><span class="n">encryptQuestionText</span><span class="p">(</span><span class="n">commentsOnly</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;button&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;needswork&#39;</span><span class="p">):</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;requestReviewQuestion&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>            
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;requestReviewQuestion&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s">&#39;There was a problem handling the form POST for Question ID:</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;reviewQuestion.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">similarQuestionsToDisplay</span> <span class="o">=</span> <span class="n">similarQuestions</span><span class="p">,</span>                                                          \
                               <span class="n">questionToDisplay</span><span class="o">=</span><span class="n">Question</span><span class="o">.</span><span class="n">addMarkupToQuestionText</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">detachAndDecryptQuestionText</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">questionOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>  \
                               <span class="n">title</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> Question #</span><span class="si">%d</span><span class="s"> For </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">],</span><span class="n">question</span><span class="o">.</span><span class="n">number</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">],</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">longName</span> <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please choose a class first.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseClass&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/generateQuiz&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">generateQuiz</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span> <span class="p">):</span>
        <span class="k">global</span> <span class="n">cachedQuestions</span>
        <span class="k">if</span> <span class="n">cachedQuestions</span><span class="p">:</span>
            <span class="n">quizNumber</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;quizID&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">quizNumber</span><span class="p">,</span> <span class="s">&quot;Generate quiz without a quiz number??&quot;</span>
            <span class="n">generatedQuiz</span><span class="p">,</span> <span class="n">generatedID</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">generateQuiz</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">quizNumber</span><span class="p">),</span> <span class="n">cachedQuestions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;generatedQuizOrExam.html&#39;</span><span class="p">,</span> <span class="n">quizNumberToDisplay</span> <span class="o">=</span> <span class="n">quizNumber</span><span class="p">,</span> <span class="n">generatedIDToDisplay</span> <span class="o">=</span> <span class="n">generatedID</span><span class="p">,</span> \
                               <span class="n">generatedQuestionsToDisplay</span> <span class="o">=</span> <span class="n">generatedQuiz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please select a quiz first.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseQuiz&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please choose a class first.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseClass&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/generateExam&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">generateExam</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">]</span> <span class="p">):</span>
        <span class="k">global</span> <span class="n">cachedQuestions</span>
        <span class="k">if</span> <span class="n">cachedQuestions</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]),</span> <span class="s">&quot;Generate final exam without a class??&quot;</span>
            <span class="k">assert</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">],</span><span class="s">&quot;Couldn&#39;t find previous class info for class: </span><span class="si">%s</span><span class="s">??&quot;</span> <span class="o">%</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">]</span>
            <span class="n">generatedExam</span><span class="p">,</span> <span class="n">generatedID</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">generateFinalExam</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;classAbbr&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;classInfo&#39;</span><span class="p">],</span> <span class="n">cachedQuestions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;generatedQuizOrExam.html&#39;</span><span class="p">,</span> <span class="n">generatedIDToDisplay</span> <span class="o">=</span> <span class="n">generatedID</span><span class="p">,</span> <span class="n">generatedQuestionsToDisplay</span> <span class="o">=</span> <span class="n">generatedExam</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please select a quiz first.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseQuiz&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Please choose a class first.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;chooseClass&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/retrieveQuizOrExam&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">retrieveQuizOrExam</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">flask.helpers</span> <span class="kn">import</span> <span class="n">get_flashed_messages</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;code&#39;</span><span class="p">]</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">questionsFromID</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">get_flashed_messages</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">flash</span> <span class="p">(</span><span class="s">&quot;No valid questions found for code: </span><span class="si">%s</span><span class="s">??&quot;</span><span class="o">%</span><span class="n">code</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;generatedQuizOrExam.html&#39;</span><span class="p">,</span> <span class="n">generatedIDToDisplay</span> <span class="o">=</span> <span class="n">code</span><span class="p">,</span> <span class="n">generatedQuestionsToDisplay</span> <span class="o">=</span> <span class="n">questions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;retrieveQuizOrExam.html&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <h6></h6>
<p>UTILITES #</p>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">currentUserFirstName</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">fullname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;?? anonymous ??&quot;</span>
    <span class="k">return</span> <span class="s">&quot;?? NO GLOBAL USER ??&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <h6></h6>
<p>SECURITY #</p>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/verifyUsers&quot;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">verifyUsers</span><span class="p">():</span>
    <span class="n">unverifiedUsers</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">getAllUnverified</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;verifyUsers.html&#39;</span><span class="p">,</span> <span class="n">unverifiedUsers</span><span class="o">=</span><span class="n">unverifiedUsers</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/verifyingUser&quot;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@admin_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">verifyingUser</span><span class="p">():</span>
    <span class="n">userToVerify</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">userToVerify</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">is_verified</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">user_datastore</span> <span class="o">=</span> <span class="n">SQLAlchemyUserDatastore</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">)</span>
            <span class="n">default_role</span> <span class="o">=</span> <span class="n">user_datastore</span><span class="o">.</span><span class="n">find_or_create_role</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
            <span class="n">user_datastore</span><span class="o">.</span><span class="n">add_role_to_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">default_role</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;User ID </span><span class="si">%d</span><span class="s"> is already verified?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">userToVerify</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find User ID </span><span class="si">%d</span><span class="s"> to verify?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">userToVerify</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;verifyUsers&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/unverifiedUser&quot;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@user_permission.require</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">unverifiedUser</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;unverifiedUser.html&#39;</span><span class="p">,</span>
        <span class="n">admins</span> <span class="o">=</span> <span class="n">getAdmins</span><span class="p">())</span>

<span class="nd">@lm.user_loader</span>
<span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
 
<span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    
<span class="nd">@identity_loaded.connect_via</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">on_identity_loaded</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">identity</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Set the identity user object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">identity</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Add the UserNeed to the identity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">):</span>
        <span class="n">identity</span><span class="o">.</span><span class="n">provides</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">UserNeed</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Assuming the User model has a list of roles, update the
identity with the roles that the user provides</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="s">&#39;roles&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="n">identity</span><span class="o">.</span><span class="n">provides</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">RoleNeed</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">security</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <h1>This processor is added to only the register view</h1>
<p>@security.register_context_processor
def security_register_processor():
    app.logger.debug("security_register_processor")</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_csrf_token</span><span class="p">():</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;generate_csrf_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;_csrf_token&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s">&#39;_csrf_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;_csrf_token&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Flask-Login token_loader callback. 
The token_loader function asks this function to take the token that was 
stored on the users computer process it to check if its valid and then 
return a User Object if its valid or None if its not valid.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@lm.token_loader</span>
<span class="k">def</span> <span class="nf">load_token</span><span class="p">(</span><span class="n">token</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>The Token itself was generated by User.get_auth_token.  So it is up to 
us to known the format of the token data itself.  </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>The Token was encrypted using itsdangerous.URLSafeTimedSerializer which 
allows us to have a max_age on the token itself.  When the cookie is stored
on the users computer it also has a exipry date, but could be changed by
the user, so this feature allows us to enforce the exipry date of the token
server side and not rely on the users cookie to exipre. </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">max_age</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;REMEMBER_COOKIE_DURATION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Decrypt the Security Token, data = [username, hashpass]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">data</span> <span class="o">=</span> <span class="n">login_serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Find the User</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Check Password and return user or None</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span>
    <span class="k">return</span> <span class="bp">None</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
