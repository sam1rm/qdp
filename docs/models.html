<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>models.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>models.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">login_serializer</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">flash</span>
<span class="kn">from</span> <span class="nn">flask.ext.security</span> <span class="kn">import</span> <span class="n">UserMixin</span><span class="p">,</span> <span class="n">RoleMixin</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
  
<span class="n">roles_users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;roles_users&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;users_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">)),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;roles_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;role.id&#39;</span><span class="p">)))</span>

<span class="n">users_questions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;users_questions&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;users_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">)),</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&#39;questions_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;question.id&#39;</span><span class="p">)))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">RoleMixin</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;Role </span><span class="si">%d</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">UserMixin</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">())</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Flask-Security Fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">confirmed_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">())</span>
    <span class="n">last_login_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">current_login_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">last_login_ip</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">current_login_ip</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">login_count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Relationships with other models</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">roles</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">&#39;Role&#39;</span><span class="p">,</span> <span class="n">secondary</span> <span class="o">=</span> <span class="n">roles_users</span><span class="p">,</span> <span class="n">backref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">&#39;dynamic&#39;</span><span class="p">))</span>
    <span class="n">questions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">&#39;Question&#39;</span><span class="p">,</span> <span class="n">secondary</span> <span class="o">=</span> <span class="n">users_questions</span><span class="p">,</span> <span class="n">backref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s">&#39;author&#39;</span><span class="p">,</span> <span class="n">lazy</span> <span class="o">=</span> <span class="s">&#39;dynamic&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Encode a secure token for cookie</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_auth_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">login_serializer</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_verified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;user&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="ow">or</span> <span class="s">&#39;admin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;admin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getAllAdmins</span><span class="p">():</span>
        <span class="n">admins</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">admins</span><span class="p">:</span>
                    <span class="n">admins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">admins</span><span class="o">=</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">admins</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hasUnverifiedUsers</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">is_verified</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getAllUnverifiedUsers</span><span class="p">():</span>
        <span class="n">unverifiedUsers</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">is_verified</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">unverifiedUsers</span><span class="p">:</span>
                    <span class="n">unverifiedUsers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unverifiedUsers</span><span class="o">=</span><span class="p">[</span><span class="n">user</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">unverifiedUsers</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;User </span><span class="si">%d</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;User #</span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>
 
<span class="k">class</span> <span class="nc">ClassInfo</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">classAbbr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">longName</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="n">startingID</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">currentID</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">classAbbr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">classAbbr</span><span class="o">=</span><span class="n">classAbbr</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;ClassInfo </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;ClassInfo </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">): startingID=</span><span class="si">%d</span><span class="s">, currentID=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classAbbr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">startingID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentID</span><span class="p">)</span>
 
<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">classID</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">modified</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">classAbbr</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">quiz</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="n">tagsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">tagsComments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">tagsCommentsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">instructionsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">instructionsComments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">instructionsCommentsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">questionIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">questionComments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">questionCommentsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">examplesIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">examplesComments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">examplesCommentsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">hints</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">hintsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">hintsComments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">hintsCommentsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">answerIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">answerComments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">answerCommentsIV</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Relationships with other models</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">reviewers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">,</span> <span class="n">secondary</span> <span class="o">=</span> <span class="n">users_questions</span><span class="p">,</span> <span class="n">backref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s">&#39;reviewers&#39;</span><span class="p">,</span> <span class="n">lazy</span> <span class="o">=</span> <span class="s">&#39;dynamic&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">questions</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find any questions in the database with (raw) ID: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Found more than one question (</span><span class="si">%d</span><span class="s">) in the database with (raw) ID: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span><span class="nb">id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">questions</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>    

    <span class="k">def</span> <span class="nf">getUsingClassID</span><span class="p">(</span><span class="n">classID</span><span class="p">):</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">classID</span><span class="o">=</span><span class="n">classID</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">questions</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find any questions in the database with (class) ID: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">classID</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Found more than one question (</span><span class="si">%d</span><span class="s">) in the database with (class) ID: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span><span class="n">classID</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">questions</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>    
    
    <span class="k">def</span> <span class="nf">tagsAsSet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">shortenedDecryptedQuestionWithMarkup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returned a short..ed version of the (unencrypted) question text with HTML markup &#39;&#39;&#39;</span>
        <span class="n">encryptedQuestion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span>
        <span class="k">if</span> <span class="n">encryptedQuestion</span><span class="p">:</span>
            <span class="n">encryptedQuesionIV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">questionIV</span> 
            <span class="n">question</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">encryptedQuestion</span><span class="p">,</span><span class="n">encryptedQuesionIV</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">question</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">80</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">38</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;...&quot;</span><span class="o">+</span><span class="n">convertToHTML</span><span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="o">-</span><span class="mi">38</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;?? NO QUESTION TEXT ??&quot;</span>

    <span class="k">def</span> <span class="nf">shortenedDecryptedTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returned a short..ed version of the (unencrypted) tags &#39;&#39;&#39;</span>
        <span class="n">encryptedTags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="k">if</span> <span class="n">encryptedTags</span><span class="p">:</span>
            <span class="n">encryptedTagsIV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagsIV</span> 
            <span class="n">tags</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">encryptedTags</span><span class="p">,</span><span class="n">encryptedTagsIV</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">80</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tags</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">38</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;...&quot;</span><span class="o">+</span><span class="n">tags</span><span class="p">[</span><span class="o">-</span><span class="mi">38</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;?? NO TAGS ??&quot;</span>
        
    <span class="k">def</span> <span class="nf">offsetNumberFromClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classInfo</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classID</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="s">&quot;self.classID (</span><span class="si">%r</span><span class="s">) != int??&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">classID</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">classInfo</span><span class="o">.</span><span class="n">startingID</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="s">&quot;classInfo.startingID (</span><span class="si">%r</span><span class="s">) != int??&quot;</span> <span class="o">%</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">startingID</span>
        <span class="n">offsetNumber</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classID</span> <span class="o">-</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">startingID</span> <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">offsetNumber</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="s">&quot;offsetNumber (</span><span class="si">%r</span><span class="s">) != int??&quot;</span> <span class="o">%</span> <span class="n">offsetNumber</span>
        <span class="k">return</span> <span class="n">offsetNumber</span>
    
    <span class="k">def</span> <span class="nf">classIDFromOffsetNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classInfo</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classID</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="s">&quot;self.classID (</span><span class="si">%s</span><span class="s">) != int??&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">classID</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">classInfo</span><span class="o">.</span><span class="n">startingID</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="s">&quot;classInfo.startingID (</span><span class="si">%s</span><span class="s">) != int??&quot;</span> <span class="o">%</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">startingID</span>
        <span class="n">classID</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">classID</span> <span class="o">+</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">startingID</span> <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">classID</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="s">&quot;classID (</span><span class="si">%r</span><span class="s">) != int??&quot;</span> <span class="o">%</span> <span class="n">classID</span>
        <span class="k">return</span> <span class="n">classID</span>
    
    <span class="k">def</span> <span class="nf">findSimilarQuestions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Find questions &quot;similar&quot; to this one. Uses quiz # and tags.</span>
<span class="sd">            TODO: Union questions with the same tag(s) - right now it&#39;s looking for equal tags. &#39;&#39;&#39;</span>
        <span class="n">existing</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagsAsSet</span><span class="p">()</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">quiz</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiz</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">instanceTags</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">tagsAsSet</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instanceTags</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">existing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">existing</span>
  
    <span class="k">def</span> <span class="nf">decryptQuestionText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">questionOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">commentsOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">commentsOnly</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">commentsOnly</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tagsIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instructionsIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">questionIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">examples</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">examplesIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hints</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hintsIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">answerIV</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">questionOnly</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">questionOnly</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagsComments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagsComments</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagsComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tagsCommentsIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructionsComments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instructionsComments</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructionsComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instructionsCommentsIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">questionComments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">questionComments</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">questionComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">questionCommentsIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">examplesComments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">examplesComments</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examplesComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">examplesIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hintsComments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hintsComments</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hintsComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hintsCommentsIV</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answerComments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">answerComments</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answerComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">answerCommentsIV</span><span class="p">)</span>
                
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">detachAndDecryptQuestionText</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">questionOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">commentsOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Decrypt all of the question text, including tags and comments. &#39;&#39;&#39;</span>
        <span class="n">convertedQuestion</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">decryptQuestionText</span><span class="p">(</span><span class="n">questionOnly</span><span class="p">,</span> <span class="n">commentsOnly</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">convertedQuestion</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">addMarkupToQuestionText</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">questionOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">commentsOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Add HTML markup to all of the question text, including tags and comments. This is mostly used for \n -&gt; &lt;br /&gt; &#39;&#39;&#39;</span>
        <span class="n">convertedQuestion</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">commentsOnly</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">commentsOnly</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">instructions</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">examples</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">examples</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">examples</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">hints</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">hints</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">hints</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">questionOnly</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">questionOnly</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">instructionsComments</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">instructionsComments</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">instructionsComments</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">questionComments</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">questionComments</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">questionComments</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">examplesComments</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">examplesComments</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">examplesComments</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">hintsComments</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">hintsComments</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">hintsComments</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">answerComments</span><span class="p">:</span>
                <span class="n">convertedQuestion</span><span class="o">.</span><span class="n">answerComments</span> <span class="o">=</span> <span class="n">convertToHTML</span><span class="p">(</span><span class="n">convertedQuestion</span><span class="o">.</span><span class="n">answerComments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">convertedQuestion</span>
 
    <span class="k">def</span> <span class="nf">encryptQuestionText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">questionOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">commentsOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Encrypt all of the question text, including tags and comments. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">commentsOnly</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">commentsOnly</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructionsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">questionIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">examplesIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hintsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">answerIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">questionOnly</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">questionOnly</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tagsComments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagsCommentsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagsComments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instructionsComments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructionsCommentsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instructionsComments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">questionComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">questionCommentsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">questionComments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">examplesComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">examplesCommentsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examplesComments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hintsComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hintsCommentsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hintsComments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answerComments</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">answerCommentsIV</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answerComments</span><span class="p">)</span>
                  
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generateQuiz</span><span class="p">(</span><span class="n">classInfo</span><span class="p">,</span> <span class="n">quizNumber</span><span class="p">,</span> <span class="n">cachedQuestions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate quiz # for a class, using previously cached questions (caller is responsible for these). </span>
<span class="sd">            TODO: Find questions with: most reviews, then different tags&#39;&#39;&#39;</span>
        <span class="n">quizQuestions</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>questions = Question.query.filter(Question.classAbbr == session['classAbbr']).all()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">cachedQuestions</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">quiz</span> <span class="o">==</span> <span class="n">quizNumber</span><span class="p">):</span>
                <span class="n">markedUpQuestion</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">addMarkupToQuestionText</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">detachAndDecryptQuestionText</span><span class="p">(</span><span class="n">question</span><span class="p">,</span><span class="n">questionOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                <span class="n">quizQuestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">markedUpQuestion</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quizQuestions</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">quizQuestions</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">IDFromQuestions</span><span class="p">(</span><span class="n">classInfo</span><span class="p">,</span> <span class="n">quizQuestions</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generateFinalExam</span><span class="p">(</span><span class="n">classInfo</span><span class="p">,</span> <span class="n">cachedQuestions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate final exam # for a class, using previously cached questions (caller is responsible for these) </span>
<span class="sd">            TODO: Find questions with: most reviews, then different tags&#39;&#39;&#39;</span>
        <span class="n">examQuestions</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>questions = Question.query.filter(Question.classAbbr == session['classAbbr']).all()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">cachedQuestions</span><span class="p">:</span>
            <span class="n">markedUpQuestion</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">addMarkupToQuestionText</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">detachAndDecryptQuestionText</span><span class="p">(</span><span class="n">question</span><span class="p">,</span><span class="n">questionOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
            <span class="n">examQuestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">markedUpQuestion</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examQuestions</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">examQuestions</span><span class="p">,</span> <span class="n">Question</span><span class="o">.</span><span class="n">IDFromQuestions</span><span class="p">(</span><span class="n">classInfo</span><span class="p">,</span> <span class="n">examQuestions</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generateIDFromQuestions</span><span class="p">(</span><span class="n">classInfo</span><span class="p">,</span> <span class="n">questions</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate an ID from quiz question ids.</span>
<span class="sd">            1024 questions per quiz possible &#39;&#39;&#39;</span>
        <span class="n">validIDSymbols</span><span class="o">=</span><span class="s">&quot;ABCDEFGHJKLMNPQRSTUVWXYZ23456789&quot;</span>
        <span class="n">numIDSymbols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">validIDSymbols</span><span class="p">)</span>
        <span class="n">idSymbols</span> <span class="o">=</span> <span class="n">classInfo</span><span class="o">.</span><span class="n">classAbbr</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
            <span class="n">idSymbols</span> <span class="o">+=</span> <span class="s">&#39;.&#39;</span>
            <span class="n">qid</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">offsetNumberFromClass</span><span class="p">(</span><span class="n">classInfo</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">qid</span> <span class="o">&gt;</span> <span class="n">numIDSymbols</span><span class="p">):</span>
                <span class="n">idSymbols</span> <span class="o">+=</span> <span class="n">validIDSymbols</span><span class="p">[</span><span class="nb">id</span><span class="o">/</span><span class="n">numIDSymbols</span><span class="p">]</span>
            <span class="n">idSymbols</span> <span class="o">+=</span> <span class="n">validIDSymbols</span><span class="p">[</span><span class="nb">id</span><span class="o">%</span><span class="n">numIDSymbols</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">idSymbols</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getQuestionsFromID</span><span class="p">(</span><span class="n">idSymbols</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Retrieve quiz question from an ID.&#39;&#39;&#39;</span>
        <span class="n">validIDSymbols</span><span class="o">=</span><span class="s">&quot;ABCDEFGHJKLMNPQRSTUVWXYZ23456789&quot;</span>
        <span class="n">numIDSymbols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">validIDSymbols</span><span class="p">)</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">questionNumbers</span> <span class="o">=</span> <span class="n">idSymbols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">questionNumbers</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;ID (</span><span class="si">%s</span><span class="s">) doesn&#39;t have any question IDs??&quot;</span> <span class="o">%</span> <span class="n">idSymbols</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">questionNumbers</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">classInfo</span> <span class="o">=</span> <span class="n">ClassInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">flash</span> <span class="p">(</span><span class="s">&quot;idSymbol (</span><span class="si">%s</span><span class="s">) isn&#39;t a valid class abbreviation.&quot;</span> <span class="o">%</span> <span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">validIDSymbols</span><span class="p">:</span>
                        <span class="n">questionNumber</span> <span class="o">=</span> <span class="n">validIDSymbols</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">symbol</span> <span class="o">=</span> <span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">validIDSymbols</span><span class="p">:</span>
                                <span class="n">questionNumber</span> <span class="o">=</span> <span class="n">questionNumber</span> <span class="o">*</span> <span class="n">numIDSymbols</span> <span class="o">+</span> <span class="n">validIDSymbols</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">flash</span><span class="p">(</span><span class="s">&quot;ID &#39;</span><span class="si">%s</span><span class="s">&#39; is invalid in code: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">idSymbols</span><span class="p">),</span> <span class="n">category</span><span class="o">=</span><span class="s">&quot;warning&quot;</span><span class="p">)</span>
                                <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flash</span><span class="p">(</span><span class="s">&quot;ID &#39;</span><span class="si">%s</span><span class="s">&#39; is invalid in code: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">idSymbols</span><span class="p">),</span> <span class="n">category</span><span class="o">=</span><span class="s">&quot;warning&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">questionClassID</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">classIDFromOffsetNumber</span><span class="p">(</span><span class="n">questionNumber</span><span class="p">,</span> <span class="n">classInfo</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">getUsingClassID</span><span class="p">(</span><span class="n">questionClassID</span><span class="p">)</span>
                        <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Question</span><span class="o">.</span><span class="n">detachAndDecryptQuestionText</span><span class="p">(</span><span class="n">question</span><span class="p">,</span><span class="n">questionOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">flash</span> <span class="p">(</span><span class="s">&quot;ID &#39;</span><span class="si">%s</span><span class="s">&#39; isn&#39;t a valid question [class] id (</span><span class="si">%d</span><span class="s">) for class: </span><span class="si">%s</span><span class="s"> in code: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">questionID</span><span class="p">,</span> <span class="n">questionNumbers</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">idSymbols</span><span class="p">),</span> <span class="n">category</span><span class="o">=</span><span class="s">&quot;warning&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
        <span class="k">return</span> <span class="n">questions</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;Question </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Question #</span><span class="si">%d</span><span class="s"> (classID: </span><span class="si">%d</span><span class="s">): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decryptAndShortenQuestion</span><span class="p">())</span>
    
<span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">LargeBinary</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getByName</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">images</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">images</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find any images in the database with filename: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Found more than one image (</span><span class="si">%d</span><span class="s">) in the database with filename: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">images</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>    
  
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;Image </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Image #</span><span class="si">%d</span><span class="s"> (size=</span><span class="si">%d</span><span class="s">): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">convertToHTML</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">flask</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Markup</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="n">flask</span><span class="o">.</span><span class="n">Markup</span><span class="p">(</span><span class="s">&#39;&lt;br /&gt;&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="kn">import</span> <span class="nn">config</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto</span> <span class="kn">import</span> <span class="n">Random</span>

<span class="kn">import</span> <span class="nn">doctest</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Encrypt a 16-byte, length-prefixed, padded message using AES.</span>
<span class="sd">        Returned message is base64 encoded. &#39;&#39;&#39;</span> 
    <span class="n">iv</span> <span class="o">=</span> <span class="n">Random</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span>
    <span class="n">OBJ</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
    <span class="n">numToPad</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">%</span> <span class="mi">16</span>
    <span class="n">paddedMessage</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%04d%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">),</span><span class="n">message</span><span class="p">,</span><span class="n">config</span><span class="o">.</span><span class="n">PADDING</span><span class="p">[:</span><span class="n">numToPad</span><span class="p">])</span>
    <span class="n">encryptedMessage</span> <span class="o">=</span> <span class="n">OBJ</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">paddedMessage</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">encryptedMessage</span><span class="p">),</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">b64Message</span><span class="p">,</span> <span class="n">IV</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Decode a base64 message using AES. Returned is original message minus the padding,</span>
<span class="sd">        which is checked for integrity (the length is also a prefix integrity checker)  &#39;&#39;&#39;</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">IV</span><span class="p">)</span>
    <span class="n">OBJ</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64Message</span><span class="p">)</span>
    <span class="n">paddedMessage</span> <span class="o">=</span> <span class="n">OBJ</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">messageLen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">paddedMessage</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">numToPad</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">(</span> <span class="n">messageLen</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">%</span> <span class="mi">16</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">paddedMessage</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="n">messageLen</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">paddedMessage</span><span class="p">[</span><span class="n">messageLen</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="n">PADDING</span><span class="p">[:</span><span class="n">numToPad</span><span class="p">]):</span>
        <span class="k">return</span> <span class="s">&quot;INVALID PADDING&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
